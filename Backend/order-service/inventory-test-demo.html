<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menu-Inventory Integration Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .header {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
      }
      .test-section {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .test-section h3 {
        margin-top: 0;
        color: #3498db;
      }
      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #2980b9;
      }
      button:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
      }
      .result {
        background-color: #ecf0f1;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        color: #27ae60;
      }
      .error {
        color: #e74c3c;
      }
      .warning {
        color: #f39c12;
      }
      .menu-item {
        display: inline-block;
        background: #3498db;
        color: white;
        padding: 5px 10px;
        margin: 2px;
        border-radius: 3px;
        font-size: 12px;
      }
      .ingredient {
        display: inline-block;
        background: #95a5a6;
        color: white;
        padding: 2px 6px;
        margin: 1px;
        border-radius: 2px;
        font-size: 11px;
      }
      .order-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üçΩÔ∏è Menu-Inventory Integration Test</h1>
        <p>Ki·ªÉm tra h·ªá th·ªëng k·∫øt n·ªëi gi·ªØa menu v√† inventory</p>
      </div>

      <div class="test-section">
        <h3>üìã 1. Recipe Information</h3>
        <button onclick="loadRecipes()">Load All Recipes</button>
        <div id="recipesResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>üì¶ 2. Inventory Status</h3>
        <button onclick="loadInventory()">Load Inventory</button>
        <div id="inventoryResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>üîç 3. Stock Checking</h3>
        <p>Test v·ªõi c√°c m√≥n ƒÉn m·∫´u:</p>
        <div class="order-item">
          <strong>Test Order:</strong><br />
          <span class="menu-item">C∆°m Chi√™n H·∫£i S·∫£n x2</span>
          <span class="menu-item">Ph·ªü B√≤ T√°i x1</span>
          <span class="menu-item">T√¥m N∆∞·ªõng Mu·ªëi ·ªöt x1</span>
        </div>
        <button onclick="checkStock()">Check Stock Availability</button>
        <div id="stockResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>‚ö†Ô∏è 4. Inventory Reduction Test</h3>
        <p><strong>WARNING:</strong> Thao t√°c n√†y s·∫Ω th·ª±c s·ª± gi·∫£m inventory!</p>
        <div class="order-item">
          <strong>Safe Test Order (Small quantity):</strong><br />
          <span class="menu-item">Tr√† ƒê√° x1</span>
        </div>
        <button onclick="testReduction()" style="background-color: #e67e22">
          Test Reduction (CAREFUL!)
        </button>
        <div id="reductionResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>üéØ 5. Custom Order Test</h3>
        <p>Test v·ªõi order t√πy ch·ªânh:</p>
        <select
          id="menuSelect"
          multiple
          style="width: 100%; height: 100px; margin-bottom: 10px"
        >
          <!-- Will be populated by JavaScript -->
        </select>
        <br />
        <label>Quantity: </label>
        <input type="number" id="customQuantity" value="1" min="1" max="10" />
        <br /><br />
        <button onclick="testCustomOrder()">Test Custom Order</button>
        <div id="customResult" class="result" style="display: none"></div>
      </div>
    </div>

    <script>
      const ORDER_SERVICE_URL = "http://localhost:5005";
      const INVENTORY_SERVICE_URL = "http://localhost:5004";

      let availableMenuItems = [];

      async function makeRequest(url, options = {}) {
        try {
          const response = await fetch(url, {
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
            ...options,
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          return await response.json();
        } catch (error) {
          throw new Error(`Request failed: ${error.message}`);
        }
      }

      async function loadRecipes() {
        const resultDiv = document.getElementById("recipesResult");
        resultDiv.style.display = "block";
        resultDiv.innerHTML = "Loading recipes...";

        try {
          const data = await makeRequest(
            `${ORDER_SERVICE_URL}/api/inventory-test/recipes`
          );

          let html = `<span class="success">‚úÖ Found ${data.totalMenuItems} recipes:</span>\n\n`;

          for (const [menuItem, recipe] of Object.entries(data.recipes)) {
            html += `üçΩÔ∏è <strong>${menuItem}</strong>\n`;
            html += `   Ingredients (${recipe.ingredients.length}):\n`;
            for (const ing of recipe.ingredients) {
              html += `   ‚Ä¢ ${ing.name}: ${ing.quantity} ${ing.unit}\n`;
            }
            html += `\n`;
          }

          // Populate menu select
          availableMenuItems = Object.keys(data.recipes);
          populateMenuSelect();

          resultDiv.innerHTML = html;
        } catch (error) {
          resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
        }
      }

      async function loadInventory() {
        const resultDiv = document.getElementById("inventoryResult");
        resultDiv.style.display = "block";
        resultDiv.innerHTML = "Loading inventory...";

        try {
          const data = await makeRequest(
            `${INVENTORY_SERVICE_URL}/api/inventory`
          );
          const items = Array.isArray(data) ? data : data.data || [];

          let html = `<span class="success">‚úÖ Found ${items.length} inventory items:</span>\n\n`;

          // Group by category
          const categories = {};
          for (const item of items) {
            const category = item.category || "Other";
            if (!categories[category]) categories[category] = [];
            categories[category].push(item);
          }

          for (const [category, categoryItems] of Object.entries(categories)) {
            html += `üìÅ <strong>${category}</strong>\n`;
            for (const item of categoryItems.slice(0, 10)) {
              // Limit to 10 per category
              const status =
                item.quantity <= (item.minQuantity || 0) ? "‚ö†Ô∏è" : "‚úÖ";
              html += `   ${status} ${item.name}: ${item.quantity} ${item.unit}`;
              if (item.price) html += ` - ${item.price.toLocaleString()} VNƒê`;
              html += `\n`;
            }
            if (categoryItems.length > 10) {
              html += `   ... and ${categoryItems.length - 10} more items\n`;
            }
            html += `\n`;
          }

          resultDiv.innerHTML = html;
        } catch (error) {
          resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
        }
      }

      async function checkStock() {
        const resultDiv = document.getElementById("stockResult");
        resultDiv.style.display = "block";
        resultDiv.innerHTML = "Checking stock...";

        const testOrder = [
          { name: "C∆°m Chi√™n H·∫£i S·∫£n", quantity: 2 },
          { name: "Ph·ªü B√≤ T√°i", quantity: 1 },
          { name: "T√¥m N∆∞·ªõng Mu·ªëi ·ªöt", quantity: 1 },
        ];

        try {
          const data = await makeRequest(
            `${ORDER_SERVICE_URL}/api/inventory-test/check-menu-stock`,
            {
              method: "POST",
              body: JSON.stringify({ orderItems: testOrder }),
            }
          );

          let html = `<span class="${
            data.data.allAvailable ? "success" : "warning"
          }">Stock Check Result: ${
            data.data.allAvailable
              ? "‚úÖ All Available"
              : "‚ö†Ô∏è Some Items Unavailable"
          }</span>\n\n`;

          for (const item of data.data.items) {
            html += `üçΩÔ∏è <strong>${item.menuItem}</strong> (${
              item.orderQuantity
            }x): ${item.available ? "‚úÖ Available" : "‚ùå Unavailable"}\n`;

            for (const ing of item.ingredients) {
              const status = ing.available ? "‚úÖ" : "‚ùå";
              html += `   ${status} ${ing.ingredientName}: need ${ing.quantityNeeded} ${ing.unit}`;
              if (ing.quantityAvailable !== undefined) {
                html += ` (have ${ing.quantityAvailable})`;
              }
              if (ing.reason && !ing.available) {
                html += ` - ${ing.reason}`;
              }
              html += `\n`;
            }
            html += `\n`;
          }

          resultDiv.innerHTML = html;
        } catch (error) {
          resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
        }
      }

      async function testReduction() {
        const resultDiv = document.getElementById("reductionResult");
        resultDiv.style.display = "block";
        resultDiv.innerHTML = "Testing inventory reduction...";

        const safeTestOrder = [{ name: "Tr√† ƒê√°", quantity: 1 }];

        try {
          const data = await makeRequest(
            `${ORDER_SERVICE_URL}/api/inventory-test/test-reduce`,
            {
              method: "POST",
              body: JSON.stringify({ orderItems: safeTestOrder }),
            }
          );

          let html = `<span class="success">‚úÖ Reduction Test Completed</span>\n\n`;

          html += `<strong>Stock Check Before Reduction:</strong>\n`;
          for (const item of data.stockCheck.items) {
            html += `üçΩÔ∏è ${item.menuItem}: ${
              item.available ? "‚úÖ Available" : "‚ùå Unavailable"
            }\n`;
          }
          html += `\n`;

          html += `<strong>Reduction Results:</strong>\n`;
          for (const result of data.reductionResult.results) {
            html += `üçΩÔ∏è <strong>${result.menuItem}</strong> (${result.orderQuantity}x): ${result.status}\n`;

            for (const ing of result.ingredients) {
              if (ing.status === "reduced") {
                html += `   ‚úÖ ${ing.ingredientName}: ${ing.oldQuantity} ‚Üí ${ing.newQuantity} ${ing.unit} (reduced ${ing.quantityReduced})\n`;
              } else {
                html += `   ‚ö†Ô∏è ${ing.ingredientName}: ${ing.status}`;
                if (ing.error) html += ` - ${ing.error}`;
                html += `\n`;
              }
            }
            html += `\n`;
          }

          resultDiv.innerHTML = html;
        } catch (error) {
          resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
        }
      }

      function populateMenuSelect() {
        const select = document.getElementById("menuSelect");
        select.innerHTML = "";

        for (const menuItem of availableMenuItems) {
          const option = document.createElement("option");
          option.value = menuItem;
          option.textContent = menuItem;
          select.appendChild(option);
        }
      }

      async function testCustomOrder() {
        const resultDiv = document.getElementById("customResult");
        const select = document.getElementById("menuSelect");
        const quantity = document.getElementById("customQuantity").value;

        if (select.selectedOptions.length === 0) {
          resultDiv.style.display = "block";
          resultDiv.innerHTML =
            '<span class="warning">‚ö†Ô∏è Please select at least one menu item</span>';
          return;
        }

        resultDiv.style.display = "block";
        resultDiv.innerHTML = "Testing custom order...";

        const customOrder = Array.from(select.selectedOptions).map(
          (option) => ({
            name: option.value,
            quantity: parseInt(quantity),
          })
        );

        try {
          const data = await makeRequest(
            `${ORDER_SERVICE_URL}/api/inventory-test/check-menu-stock`,
            {
              method: "POST",
              body: JSON.stringify({ orderItems: customOrder }),
            }
          );

          let html = `<strong>Custom Order Test:</strong>\n`;
          for (const item of customOrder) {
            html += `üçΩÔ∏è ${item.name} x${item.quantity}\n`;
          }
          html += `\n`;

          html += `<span class="${
            data.data.allAvailable ? "success" : "warning"
          }">Result: ${
            data.data.allAvailable
              ? "‚úÖ All Available"
              : "‚ö†Ô∏è Some Items Unavailable"
          }</span>\n\n`;

          for (const item of data.data.items) {
            html += `üçΩÔ∏è <strong>${item.menuItem}</strong>: ${
              item.available ? "‚úÖ Available" : "‚ùå Unavailable"
            }\n`;

            const unavailableIngredients = item.ingredients.filter(
              (ing) => !ing.available
            );
            if (unavailableIngredients.length > 0) {
              html += `   Unavailable ingredients:\n`;
              for (const ing of unavailableIngredients) {
                html += `   ‚ùå ${ing.ingredientName}: ${ing.reason}\n`;
              }
            }
            html += `\n`;
          }

          resultDiv.innerHTML = html;
        } catch (error) {
          resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
        }
      }

      // Load recipes on page load
      window.onload = function () {
        loadRecipes();
      };
    </script>
  </body>
</html>
